<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My WishList â€” Tommy</title>

  <style>
    :root{
      --urgent-glow: 0 0 12px rgba(255,0,0,0.45);
      --bg: #f2f2f7;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #007aff;
      --shadow: 0 8px 24px rgba(16,24,40,0.06);
      --radius: 14px;
      --max-width: 900px;
      --gap: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg),#eef2f7 120%);
      color:#111827;
      padding:36px 18px;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{max-width:var(--max-width);margin:0 auto}

    header{
      display:flex;flex-direction:column;gap:8px;align-items:center;margin-bottom:22px
    }
    h1{margin:0;font-size:2.1rem;color:#ef4444}
    p.lead{margin:0;color:var(--muted)}

    .controls{display:flex;gap:10px;align-items:center;margin:18px 0;flex-wrap:wrap;justify-content:center}
    .btn{padding:9px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,122,255,0.12)}

    #wishlist{list-style:none;margin:0;padding:0;display:grid;grid-template-columns:1fr;gap:var(--gap)}

    .item{
      position:relative;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(15,23,42,0.03);
      isolation: isolate;
      width: 100%;
      min-height: 78px;
      display: flex;
      flex-direction: column;
    }

    .item-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:16px;
      cursor:pointer;
      position: relative;
      z-index: 2;
      background: var(--card);
    }

    .item-header:focus{outline:3px solid rgba(0,122,255,0.12);}

    .thumb{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,#f8fafc,#eef2ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#374151}

    .title{font-weight:700;font-size:1.05rem}
    .meta{color:var(--muted);font-size:0.95rem}

    .toggle-icon{margin-left:auto;display:inline-flex;align-items:center;justify-content:center;transition:transform .25s ease}
    .item.open .toggle-icon{transform:rotate(180deg)}

    .submenu{
      overflow:hidden;
      max-height:0;
      transition:max-height .32s cubic-bezier(.22,.9,.3,1);
      background:#fbfdff;
      border-top:1px solid #f1f5f9;
      position: relative;
      z-index: 0;
    }
    .item.open .submenu{
      max-height:2000px;
    }
    .submenu-inner{display:flex;flex-direction:column;padding:10px}
    .subitem{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px}
    .subitem + .subitem{margin-top:8px}

    a.link{color:var(--accent);text-decoration:none;font-weight:600}
    a.link:hover{text-decoration:underline}

    .loader{padding:18px;text-align:center;color:var(--muted)}
    .error{padding:18px;text-align:center;color:#b91c1c}

    @media(min-width:720px){
      #wishlist{grid-template-columns:repeat(2,1fr)}
    }

    .urgent-item{
      box-shadow: var(--urgent-glow), var(--shadow);
      border: 1px solid rgba(255,0,0,0.35) !important;
    }

    .btn.filter-urgent.active{
      background:#ff3b30 !important;
      color:#fff !important;
      border-color:#ff3b30 !important;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>My WishList</h1>
      <p class="lead">Lista caricata dal file <code>wishlist.json</code>. Apri categorie e vedi i link urgenti.</p>

      <div class="controls">
        <button id="urgentOnly" class="btn filter-urgent">Mostra solo urgenti</button>
        <button id="toggleAll" class="btn ghost">Apri tutti</button>
      </div>
    </header>

    <main>
      <ul id="wishlist" aria-live="polite">
        <li class="loader">Caricamento...</li>
      </ul>
    </main>
  </div>

  <script>
    const WISHLIST_URL = 'wishlist.json';
    
    let fullItems = [];
    let urgentFilter = false;
    
    const listEl = document.getElementById('wishlist');
    const toggleAllBtn = document.getElementById('toggleAll');
    const urgentBtn = document.getElementById('urgentOnly');

    // Load data
    async function load(){
      try{
        const res = await fetch(WISHLIST_URL, {cache: 'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('Formato JSON non valido');
        
        fullItems = data.slice();

        // Mark categories with urgent subitems
        fullItems.forEach(item => {
            if (Array.isArray(item.subitems)) {
                item.isCategoryUrgent = item.subitems.some(sub => !!sub.urgent);
            }
        });

        // Sort by urgency then alphabetically
        fullItems.sort((a, b) => {
            const urgentA = !!a.urgent || !!a.isCategoryUrgent;
            const urgentB = !!b.urgent || !!b.isCategoryUrgent;
            if (urgentA !== urgentB) {
                return (urgentB ? 1 : 0) - (urgentA ? 1 : 0);
            }
            return (a.name||'').localeCompare(b.name||'', 'it');
        });

        render();
      }catch(err){
        console.error(err);
        listEl.innerHTML = `<li class="error">Impossibile caricare wishlist: ${err.message}</li>`;
      }
    }

    // Render items
    function render(){
      let items = urgentFilter 
        ? fullItems.filter(it => !!it.urgent || !!it.isCategoryUrgent)
        : fullItems;
      
      if(!items.length) { 
        listEl.innerHTML = '<li class="loader">Nessun elemento trovato</li>'; 
        return; 
      }
      
      listEl.innerHTML = '';
      items.forEach(item => {
        const li = createItem(item);
        listEl.appendChild(li);
      });
    }

    // Create item element
    function createItem(item){
      const isUrgent = !!item.urgent || !!item.isCategoryUrgent;
      
      // Filter subitems if urgent filter is active
      let subitems = item.subitems || [];
      if (urgentFilter && Array.isArray(subitems)) {
        subitems = subitems.filter(sub => !!sub.urgent);
      }
      
      const li = document.createElement('li');
      li.className = 'item' + (isUrgent ? ' urgent-item' : '');
      
      // Header
      const header = document.createElement('div');
      header.className = 'item-header';
      
      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      thumb.textContent = (item.name || '?').slice(0,2).toUpperCase();
      
      const titleWrap = document.createElement('div');
      titleWrap.innerHTML = `
        <div class="title">${escapeHtml(item.name || 'Unnamed')}</div>
        <div class="meta">${item.link ? `<a class="link" href="${escapeHtml(item.link)}" target="_blank" rel="noopener">Apri link</a>` : 'Categoria'}</div>
      `;
      
      const toggle = document.createElement('div');
      toggle.className = 'toggle-icon';
      toggle.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
      
      header.appendChild(thumb);
      header.appendChild(titleWrap);
      
      if(!!item.urgent){
        const badge = document.createElement('span');
        badge.style.cssText = 'background:#ff3b30;color:#fff;padding:4px 8px;border-radius:8px;font-size:0.75rem;font-weight:700';
        badge.textContent = 'URGENTE';
        header.appendChild(badge);
      }
      
      header.appendChild(toggle);
      li.appendChild(header);
      
      // Submenu
      if(subitems.length > 0){
        const submenu = document.createElement('div');
        submenu.className = 'submenu';
        
        const inner = document.createElement('div');
        inner.className = 'submenu-inner';
        
        subitems.forEach(sub => {
          const subitem = document.createElement('div');
          subitem.className = 'subitem';
          
          const a = document.createElement('a');
          a.className = 'link';
          a.textContent = sub.name || 'Unnamed';
          a.href = sub.link || '#';
          a.target = sub.link ? '_blank' : '';
          a.rel = sub.link ? 'noopener noreferrer' : '';
          subitem.appendChild(a);
          
          if(sub.urgent){
            const badge = document.createElement('span');
            badge.style.cssText = 'margin-left:auto;background:#ff3b30;color:#fff;padding:4px 8px;border-radius:8px;font-size:0.75rem;font-weight:700';
            badge.textContent = 'URGENTE';
            subitem.appendChild(badge);
          }
          
          inner.appendChild(subitem);
        });
        
        submenu.appendChild(inner);
        li.appendChild(submenu);
        
        // Toggle handler - properly isolated for each item
        header.addEventListener('click', function(e){
          // Don't toggle if clicking a link
          if(e.target.tagName === 'A' || e.target.closest('a')) {
            return;
          }
          
          // Stop propagation
          e.stopPropagation();
          
          // Toggle only THIS specific item
          li.classList.toggle('open');
        });
      }
      
      return li;
    }

    // Escape HTML
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
      })[c]);
    }

    // Urgent filter button
    urgentBtn.onclick = function(){
      urgentFilter = !urgentFilter;
      this.classList.toggle('active', urgentFilter);
      
      // Close all before re-rendering
      document.querySelectorAll('.item.open').forEach(item => {
        item.classList.remove('open');
      });
      
      render();
      
      // Auto-expand if urgent filter active
      if(urgentFilter){
        setTimeout(() => {
          document.querySelectorAll('.item').forEach(item => {
            item.classList.add('open');
          });
          toggleAllBtn.textContent = 'Chiudi tutti';
        }, 50);
      } else {
        toggleAllBtn.textContent = 'Apri tutti';
      }
    };

    // Toggle all button
    toggleAllBtn.onclick = function(){
      const openItems = document.querySelectorAll('.item.open');
      const allItems = document.querySelectorAll('.item');
      
      if(openItems.length > 0){
        allItems.forEach(item => item.classList.remove('open'));
        this.textContent = 'Apri tutti';
      } else {
        allItems.forEach(item => item.classList.add('open'));
        this.textContent = 'Chiudi tutti';
      }
    };

    // Initialize
    load();
  </script>
</body>
</html>